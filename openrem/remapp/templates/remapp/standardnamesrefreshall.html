{% extends "remapp/base.html" %}

    {% block headextras %}
    <!-- Including chartCommonFunctions to use urlToArray and arrayToUrl functions -->
    <script src="{{ STATIC_URL }}js/charts/chartCommonFunctions.js"></script>
    {% endblock %}


{% block confnav %}<li class="dropdown active">{% endblock %}

{% block navhelp %}
        <li>
            <a href="https://docs.openrem.org/en/{{ admin.docsversion }}/" target="_blank"
               data-toggle="tooltip" title="OpenREM documentation - opens in a new tab">
                OpenREM documentation
            </a>
        </li>
{% endblock %}

{% block mainblock %}

      <div class="row">
      <div class="col-md-6 col-md-offset-3">
        <div class="ajax-progress"><img src="{{ STATIC_URL }}img/ajax-loader.gif"></div>
          <h3>Refresh standard name database links for the {{ modality }} modality</h3>
        {% if admin.admingroup %}
            <p>Clicking the button below will remove all internal database links between the standard name table and the
                study and acquisition tables. The links will then be re-written. This may take several minutes if you
                have a large number of studies and a large number of standard names configured.</p>
            <p>This is useful if you have manually updated or restored the standard names database table and need to
                force the database to refresh the links between this table and the study and acquisition data tables.
            </p>
            <a class="btn btn-default" id="{{ modality }}-button">Refresh {{ modality }} standard names</a>
            <a class="btn btn-default" id="return-button" href="{% url 'standard_names_view' %}" >Return to standard name list</a>
        {% else %}
            <p>Only users in the Admin group can modify these settings.</p>
        {% endif %}
      </div>
    </div>

    <script>
        $(document).ready(function() {
            var requestData = arrayToURL(urlToArray(this.URL));

            $("#{{ modality }}-button").click(function(e) {
                e.preventDefault();
                $("#{{ modality }}-button").text("Refreshing database - this may take some time").attr("disabled", true);
                $("#return-button").attr("disabled", true);
                $(".ajax-progress").show();
                $.ajax({
                    type: "GET",
                    url: "{% url 'update_all_std_names' modality %}",
                    data: requestData,
                    dataType: "json",
                    success: function( json ) {
                        update_messages(json.messages);
                        $(".ajax-progress").hide();
                        $("#{{ modality }}-button").text("Refresh {{ modality }} standard names").removeAttr("disabled");
                        $("#return-button").removeAttr("disabled");
                    },
                    error: function( xhr, status, errorThrown ) {
                        $(".ajax-progress").hide();
                        $("#{{ modality }}-button").text("Refresh of {{ modality }} standard names failed - try again?").removeAttr("disabled");
                        $("#return-button").removeAttr("disabled");
                        console.log( "Error: " + errorThrown );
                        console.log( "Status: " + status );
                        console.dir( xhr );
                    }
                });
                return false;
            })
        });

        function update_messages(messages) {
            $.each(messages, function (i, m) {
                var button = "<button type='button' class='close' data-dismiss='alert' aria-label='close'><span aria-hidden='true'>x</span></button>";
                var msg_div = "<div class='alert alert-" + m.level + " alert-dismissible fade-in'>" + button + m.message + "</div>";
                $(msg_div).insertBefore(".row");
            });
        }
    </script>
{% endblock %}
